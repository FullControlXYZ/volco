# VOLCO Finite Element Analysis (FEA) Module

This module provides structural analysis capabilities for voxel models generated by VOLCO simulations. It enables you to analyze the mechanical behavior of 3D printed parts under load, visualize results, and save/load analysis data.

## Features

- Convert voxel matrices to finite element meshes
- Apply boundary conditions to the mesh
- Solve linear static structural problems
- Visualize displacements, stresses, and strains with optimized rendering
- Compare original and deformed meshes in a single visualization
- Save and load analysis results in various formats

## Basic Usage

```python
from volco import run_simulation
from app.postprocessing.fea import analyze_voxel_matrix

# Run VOLCO simulation
output = run_simulation(
    gcode_path='examples/gcode_example.gcode',
    printer_config_path='examples/printer_settings.json',
    sim_config_path='examples/simulation_settings.json'
)

# Get the voxel matrix from the simulation output
voxel_matrix = output.voxel_space.space
voxel_size = output._simulation.voxel_size

# Run FEA analysis
results = analyze_voxel_matrix(
    voxel_matrix=voxel_matrix,
    voxel_size=voxel_size
)

# Access results
print(f"Maximum displacement: {results['max_displacement']} mm")
print(f"Maximum von Mises stress: {results['max_von_mises']} MPa")

# If visualization was enabled
if 'visualization' in results:
    from app.postprocessing.fea.viz import export_visualization
    export_visualization(results['visualization'], "fea_results.html")
```

## API Reference

### Main Functions

#### `analyze_voxel_matrix(voxel_matrix, voxel_size, **options)`

Perform finite element analysis on a voxel matrix.

**Parameters:**
- `voxel_matrix`: 3D numpy array representing the voxel model (1 = material, 0 = void)
- `voxel_size`: Size of each voxel in mm
- `material_properties`: Dictionary containing material properties (optional)
  - `young_modulus`: Young's modulus in MPa (default: 2000 for typical PLA)
  - `poisson_ratio`: Poisson's ratio (default: 0.3 for typical PLA)
- `boundary_conditions`: Dictionary specifying boundary conditions (optional)
  - `displacement_percentage`: Percentage of model height for top displacement (default: 1.0)
  - `custom_top_bc`: Custom function for top surface boundary conditions
  - `custom_bottom_bc`: Custom function for bottom surface boundary conditions
- `visualization`: Whether to generate visualization (default: True)
- `result_type`: Type of result to visualize ('displacement', 'von_mises')
- `scale_factor`: Factor to scale displacements for visualization (default: 1.0)
- `show_undeformed`: Whether to show the original undeformed mesh alongside the deformed mesh (default: False)
- `original_opacity`: Opacity of the original mesh when shown (default: 0.3)
- `save_results`: Whether to save results to a file (default: False)
- `save_path`: Path to save results (default: 'Results_volco/fea/results')
- `save_format`: Format to save results ('pickle', 'json', or 'hdf5') (default: 'pickle')
- `include_visualization`: Whether to include visualization in saved file (default: False)

**Returns:**
Dictionary containing analysis results:
- `nodes`: Node coordinates
- `elements`: Element connectivity
- `displacements`: Nodal displacements
- `stresses`: Element stresses
- `strains`: Element strains
- `von_mises`: von Mises stress for each element
- `max_displacement`: Maximum displacement magnitude
- `max_von_mises`: Maximum von Mises stress
- `visualization`: Visualization object (if visualization=True)
- `saved_file`: Path to saved results file (if save_results=True)

#### `load_fea_results(file_path)`

Load FEA results from a file.

**Parameters:**
- `file_path`: Path to the file containing saved FEA results

**Returns:**
Dictionary containing the loaded FEA results

## Examples

### Basic Analysis

```python
results = analyze_voxel_matrix(
    voxel_matrix=voxel_matrix,
    voxel_size=voxel_size,
    visualization=True,
    result_type='von_mises',
    scale_factor=10.0  # Exaggerate deformation for visualization
)
```

### Custom Material Properties

```python
# Define material properties for ABS
material_properties = {
    'young_modulus': 2300.0,  # MPa (typical for ABS)
    'poisson_ratio': 0.35     # Typical for ABS
}

results = analyze_voxel_matrix(
    voxel_matrix=voxel_matrix,
    voxel_size=voxel_size,
    material_properties=material_properties
)
```

### Custom Boundary Conditions

```python
# Define custom boundary conditions
boundary_conditions = {
    'displacement_percentage': 2.0  # 2% displacement instead of default 1%
}

results = analyze_voxel_matrix(
    voxel_matrix=voxel_matrix,
    voxel_size=voxel_size,
    boundary_conditions=boundary_conditions
)
```

### Saving Results

```python
results = analyze_voxel_matrix(
    voxel_matrix=voxel_matrix,
    voxel_size=voxel_size,
    save_results=True,
    save_path='Results_volco/fea/my_analysis',
    save_format='pickle'
)
```

### Loading Results

```python
from app.postprocessing.fea import load_fea_results

# Load results
loaded_results = load_fea_results('Results_volco/fea/my_analysis.pkl')

# Create visualization from loaded results
from app.postprocessing.fea.viz import visualize_fea, export_visualization
viz = visualize_fea(
    nodes=loaded_results['nodes'],
    elements=loaded_results['elements'],
    displacements=loaded_results['displacements'],
    von_mises=loaded_results['von_mises'],
    result_type='von_mises',
    scale_factor=1.0,
    show_undeformed=True  # Show both original and deformed meshes
)

# Export the visualization to an HTML file
export_visualization(viz, "visualization.html")
```

## Example Files

For complete examples, see:
- [examples/fea_example.py](../../../examples/fea_example.py) - Basic example of FEA analysis
- [examples/fea_save_results.py](../../../examples/fea_save_results.py) - Example of saving FEA results
- [examples/fea_load_results.py](../../../examples/fea_load_results.py) - Example of loading and visualizing FEA results

## Module Structure

- `__init__.py`: Module entry point
- `core.py`: Main analysis functionality
- `mesh.py`: Mesh generation from voxel matrices
- `boundary.py`: Boundary condition application
- `solver.py`: Linear static FEA solver
- `viz.py`: Visualization of results using optimized mesh rendering
- `io.py`: Input/output functionality for saving/loading results

For a comprehensive overview of the module structure and functionality, see [llm_ref_fea.md](../../../llm_ref_fea.md).

## Visualization Features

The FEA module includes advanced visualization capabilities through the `visualize_fea()` function:

### Optimized Mesh Visualization

The visualization uses the "volco mesh visualization method" which:
- Only renders visible faces of the mesh (faces that are exposed to the outside)
- Creates a 3D grid representation of the voxel structure to determine visibility
- Triangulates quadrilateral faces for better rendering
- Significantly improves performance for large models by reducing the number of rendered faces

### Unified Visualization Function

The `visualize_fea()` function provides a unified interface for all visualization needs:

```python
from app.postprocessing.fea.viz import visualize_fea, export_visualization

# Create visualization
viz = visualize_fea(
    nodes=results['nodes'],
    elements=results['elements'],
    displacements=results['displacements'],
    von_mises=results['von_mises'],
    result_type='von_mises',  # or 'displacement'
    scale_factor=10.0,        # Exaggerate deformation
    show_undeformed=True,     # Show original mesh alongside deformed
    original_opacity=0.3      # Transparency of original mesh
)

# Export to HTML file
export_visualization(viz, "fea_results.html")
```

### Visualization Options

- **Result Types**: Choose between 'displacement' or 'von_mises' stress visualization
- **Dual Mesh View**: Show both original and deformed meshes in a single visualization
- **Scale Factor**: Control the exaggeration of displacements for better visibility
- **Original Mesh Opacity**: Adjust transparency of the original mesh when shown

### Example: Visualizing Both Original and Deformed Meshes

```python
# Visualize both original and deformed meshes with von Mises stress
viz = visualize_fea(
    nodes=results['nodes'],
    elements=results['elements'],
    displacements=results['displacements'],
    von_mises=results['von_mises'],
    result_type='von_mises',
    scale_factor=5.0,
    show_undeformed=True,
    original_opacity=0.2  # More transparent original mesh
)

# Export to HTML file
export_visualization(viz, "comparison_viz.html")
```